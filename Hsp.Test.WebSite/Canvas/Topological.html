<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>拓扑图测试</title>
    <script src="../Scripts/jquery-1.8.3.js"></script>

    <script src="../Scripts/Hsp.js"></script>
    <script src="../Scripts/Hsp.Common.js"></script>

    <style type="text/css">
        
        *{ padding: 0;margin: 0;}

        body{ margin: 2px;
            overflow: hidden;
        }

         canvas {
             border: 1px solid #ADACB0;
             display: block;
             margin: 0 auto;

             /*background-color*/

             /*width: 100%;
             height: 100%;*/

             /*width: 900px;*/
             /*height: 450px;*/
         }


    </style>




</head>
<body>

<canvas id="myCanvas">
Your browser does not support the HTML5 canvas tag.
</canvas>

<script type="text/javascript">

    var $topoInit;
    var cav_width = 0, cav_height = 0;

    $topoInit = {
        DRAWING_DIRECTION: "vertical", // 绘图方向：horizontal-水平；vertical-垂直；
        FONT_SIZE: 16, // 字体大小
        BORDER_TEXT_GAP: 8, // 文字与边框间隔
        BORDER_RADIUS: 4, // 圆角半径
        CELL_MIN_GAP: 16, // 单元最小间隔
        GROUP_MIN_GAP: 32, // 分组最小间隔
        LEVEL_MIN_GAP: 64, // 层级最小间隔
        TEXT_LINE_COUNT: 1, // 文字行数
        BOTTOM_GAP: 25,// 底部间距
        LINE_WIDTH: 1, // 边框线宽度
        STROKE_STYLE: "#808080", // 边框线颜色
    };

    var title = "泛能交易";
    var text = ["电力要求", "多能源交易协同要求", "交易评价", "燃气要求", "热力要求", "综合能源交易总体要求"];

    var chartWidth = 0; // 绘图区域宽度
    var maxTextLength = 0, maxRectHight = 0, maxRectWidth = 0;
    var x = 0, y = 0;

    maxRectWidth = $topoInit.FONT_SIZE * $topoInit.TEXT_LINE_COUNT + $topoInit.BORDER_TEXT_GAP * 2;

    $(function() {
        cav_width = HSP.Common.AvailWidth();
        cav_height = HSP.Common.AvailHeight();

        //alert(height);

        //$("canvas").css({ "width": (width - 6) + "px", "heigth": (height - 558) + "px" });

        var c = document.getElementById("myCanvas"); //用getElementById获取到canvas对象
        c.width = cav_width - 6, c.height = cav_height - 6;

        var ctx = c.getContext("2d"); //取得上下文

        //var canvas = document.createElement("canvas");
        //canvas.style.border = "solid 1px red";
        //canvas.id = "canvas";
        //var box = document.getElementById("canvas_box");
        //box.appendChild(canvas);

        //设置宽高一定要在canvas节点添加之后
        //document.getElementById("canvas").width = 600;
        //document.getElementById("canvas").height = 600;

        $.each(text, function() {
            if (maxTextLength < this.length) maxTextLength = this.length;
        });

        maxRectHight = maxTextLength * $topoInit.FONT_SIZE * (1 + 0.25);
        chartWidth = text.length * maxRectWidth + (text.length - 1) * $topoInit.CELL_MIN_GAP;

        //alert(maxTextLength + " * " + maxRectHight + " * " + chartWidth);
        //context.rect(x, y, width, height);

        x = (cav_width - chartWidth) / 2;
        y = cav_height - maxRectHight - $topoInit.BOTTOM_GAP;



        //ctx.beginPath();
        //ctx.lineWidth = $topoInit.LINE_WIDTH;
        //ctx.strokeStyle = $topoInit.STROKE_STYLE;
        //ctx.rect(x, y, maxRectWidth, maxRectHight);
        //ctx.stroke();

        var left = 0, top = 0;

        $.each(text, function (i) {

            left = x + i * (maxRectWidth + $topoInit.CELL_MIN_GAP);
 
            ctx.beginPath();
            ctx.lineWidth = $topoInit.LINE_WIDTH;
            ctx.strokeStyle = $topoInit.STROKE_STYLE;
            ctx.rect(left, y, maxRectWidth, maxRectHight);
            ctx.stroke();

        });

        //ctx.font = $topoInit.FONT_SIZE + "px 微软雅黑";
        //ctx.fillText("综合能源交易总体要求", x + 60, y, $topoInit.FONT_SIZE);


        $.each(text, function (i) {

            left = x + $topoInit.BORDER_TEXT_GAP + i * (maxRectWidth + $topoInit.CELL_MIN_GAP);
            canvasTextAutoLine(ctx, this, left, y + $topoInit.BORDER_TEXT_GAP - 2, $topoInit.FONT_SIZE);

        });



        // 标题处理，水平

        // 标题框线
        var titleTextLength = title.length;
        var titleRectWidth = titleTextLength * $topoInit.FONT_SIZE * (1 + 0.25);
        var titleRectHeight = $topoInit.FONT_SIZE * $topoInit.TEXT_LINE_COUNT + $topoInit.BORDER_TEXT_GAP * 2;

        left = (cav_width - titleRectWidth) / 2;
        top = cav_height - maxRectHight - $topoInit.BOTTOM_GAP - titleRectHeight - $topoInit.LEVEL_MIN_GAP;

        ctx.beginPath();
        ctx.lineWidth = $topoInit.LINE_WIDTH;
        ctx.strokeStyle = $topoInit.STROKE_STYLE;
        ctx.rect(left, top, titleRectWidth, titleRectHeight);
        ctx.stroke();

        // 标题文字
        //left = x + $topoInit.BORDER_TEXT_GAP;
        //canvasTextAutoLine(ctx, this, left + $topoInit.BORDER_TEXT_GAP, y + $topoInit.BORDER_TEXT_GAP - 2, $topoInit.FONT_SIZE);

        ctx.font = $topoInit.FONT_SIZE + "px 微软雅黑";
        ctx.fillText(title, left + $topoInit.BORDER_TEXT_GAP, top + $topoInit.BORDER_TEXT_GAP + $topoInit.FONT_SIZE - 2);

        // 绘制连接线

        // A 部分，顶部，单线
        var xa = left + titleRectWidth / 2;
        var ya = top + titleRectHeight;

        // B 部分，中间连接节点
        var xb = xa;
        var yb = ya + $topoInit.LEVEL_MIN_GAP / 2;

        ctx.moveTo(xa, ya);
        ctx.lineTo(xb, yb);
        ctx.stroke(); // 绘制

        // C 部分 中间拐点
        var xc = 0;
        var yc = yb;

        // D 部分 子节点顶部
        var xd = 0;
        var yd = 0;

        $.each(text, function (i) {

            xd = x + i * (maxRectWidth + $topoInit.CELL_MIN_GAP) + maxRectWidth / 2;
            yd = y;
            xc = xd;

            ctx.beginPath();
            ctx.moveTo(xd, yd);
            ctx.lineTo(xc, yc);
            ctx.lineTo(xb, yb);
            ctx.stroke();



            //canvasTextAutoLine(ctx, this, left, y + $topoInit.BORDER_TEXT_GAP - 2, $topoInit.FONT_SIZE);

        });





    });




    /*
    str:要绘制的字符串
    canvas:canvas对象
    initX:绘制字符串起始x坐标
    initY:绘制字符串起始y坐标
    lineHeight:字行高，自己定义个值即可
    */
    function canvasTextAutoLine(ctx, str, initX, initY, lineHeight) {
        //var ctx = canvas.getContext("2d"); 
        var lineWidth = 0;
        var canvasWidth = lineHeight; // c.width; 
        var lastSubStrIndex = 0;
        ctx.font = $topoInit.FONT_SIZE + "px 微软雅黑";
        for (var i = 0; i < str.length; i++) {
            lineWidth += ctx.measureText(str[i]).width;
            if (lineWidth > canvasWidth - initX) { //减去initX,防止边界出现的问题
                ctx.fillText(str.substring(lastSubStrIndex, i), initX, initY);
                initY += lineHeight * 1.15;
                lineWidth = 0;
                lastSubStrIndex = i;
            }
            if (i == str.length - 1) {
                ctx.fillText(str.substring(lastSubStrIndex, i + 1), initX, initY);
            }
        }
    }









</script>





</body>
</html>
