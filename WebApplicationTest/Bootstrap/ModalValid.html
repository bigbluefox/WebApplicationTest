<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>bootstrap-modal-form Validator Test</title>

<link href="/Scripts/bootstrap/css/bootstrap.min.css" rel="stylesheet"/>
<!--<link href="/Scripts/bootstrap/css/bootstrap-theme.min.css" rel="stylesheet"/>-->
<link href="/Scripts/bootstrap/css/font-awesome.css" rel="stylesheet"/>
<link href="/Scripts/bootstrap/css/bootstrap-validator.css" rel="stylesheet"/>

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
    <script src="../Scripts/html5shiv.min.js"></script>
    <script src="../Scripts/respond.min.js"></script>
<![endif]-->

<script src="/Scripts/jquery/jquery-1.12.4.min.js"></script>
<script src="/Scripts/jquery/jquery-migrate-1.4.1.min.js"></script>

<script src="/Scripts/bootstrap/js/bootstrap.js"></script>

<script src="/Scripts/bootstrap/js/bootstrap-validator.js"></script>
<script src="/Scripts/bootstrap/js/locales/bootstrap-validator-zh-CN.js"></script>

<style type="text/css">
    body { padding: 15px; }
.text-aqua {
    color: #00c0ef !important;
}

</style>

<script type="text/javascript">

    var progressModalId = "progressModal", $progressModal = null; // 进度条窗体及对象
    var editModalId = "editModal", $editModal = null, $editForm = null; // 编辑窗体及对象
    var circleModalId = "circleModal", $circleModal = null; // 圆形进度条窗体及对象

    $(function () {

        $("#btnProgressBar").unbind("click").bind('click', function () {
            modalInit(progressModalId, "操作正在进行中，请稍候...");
            progressMessage(progressModalId);

            var value = 0, time = 25000, span = time / 100, timer = null;
            var $progressModal = $("#" + progressModalId)
                , $progressBar = $("#" + progressModalId + " .progress-bar");

            var progress = function () {
                value += 1;
                $progressBar.css("width", value * 1 + "%").text(value + "%");

                if (value * span > time - 1) {
                    window.clearInterval(timer);
                    $progressModal.modal("hide");
                }
            }

            $('#' + progressModalId).on('shown.bs.modal', function () {
                $progressBar.css("width", value + "%").text(value + "%");
                timer = window.setInterval(progress, span);
            });

            $("#" + progressModalId).on("hidden.bs.modal", function () {
                value = 0;
                $progressBar.css("width", value + "%").text(value + "%");
            });



            $("#" + progressModalId).modal("toggle");
        });

        $("#btnEditModal").unbind("click").bind('click', function () {
            var selectedData = [];
            modalInit(editModalId, "课程管理", "modal-lg");
            editModalLoad(editModalId, false, selectedData, onEditCallback);
            $("#" + editModalId).modal("toggle");
        });

        // btnCircleBar

        var countdown = 60, inter = null;
        var settime = function (obj) {
            if (countdown == 0) {
                //val.removeAttribute("disabled");
                //val.value = "免费获取验证码";
                //$("#" + circleModalId).modal("toggle");
                window.clearInterval(inter);
                $("#" + circleModalId).modal("hide");
                countdown = 60;
            } else {
                //val.setAttribute("disabled", true);
                //val.value = "重新发送(" + countdown + ")";

                countdown--;
                obj.text(countdown);
            }
            //setTimeout(function() {
            //    settime(obj);
            //}, 1000);
        }



        $("#btnCircleBar").unbind("click").bind('click', function () {
            circleMessage(circleModalId, '保存操作正在操作进行中......');
            $("#" + circleModalId).modal("toggle");
            //settime($(".timer"));

            inter = setInterval(function () { settime($("#" + circleModalId + " h4 small.timer")) }, 1000);
        });



    });

    function onEditCallback(data) {

        $("#" + editModalId).on("hidden.bs.modal", function() {
            $("#" + editModalId).remove(); // 移除模态窗体对象，必须
        });

    };


    // 模态窗体初始化
    var modalInit = function (modalId, title, modalSize) {

        modalSize = modalSize || "";
        var $body = $("body");
        var $modal = $('<div id="' + modalId + '" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="' + modalId + 'Label">' +
            "</div>");

        var $content = $('\
        <div class="modal-dialog ' + modalSize + '" role="document">\
            <div class="modal-content">\
                <div class="modal-header">\
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">\
                        <span aria-hidden="true">&times;</span></button>\
                    <h4 class="modal-title" id="' + modalId + 'Label">' + title + '</h4>\
                </div>\
                <div class="modal-body"></div>\
                <div class="modal-footer"></div>\
            </div>\
        </div>');

        if ($body.length) {
            $content.appendTo($modal);
            $modal.appendTo($body);
        }

    };

    // 滚动条模态窗体
    var progressMessage = function (modalId, title) {

        $("#" + modalId + " .model-sub-title").html(title);

        var $content = $('\
                <div class="progress" style="margin-top: 15px;">\
                    <div class="progress-bar progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="min-width: 2em;">\
                        <span>0%</span>\
                    </div>\
                </div>');

        $content.appendTo($('#' + modalId + " .modal-body"));

        // 模态窗体关闭事件 
        $("#" + modalId).on("hidden.bs.modal", function () {
            $("#" + modalId).remove();
        });


    };

    // 圆形进度条模态窗体
    var circleMessage = function (modalId, title) {

        var $body = $("body");
        var $modal = $('<div id="' + modalId + '" class="modal fade" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog"></div>');

        var $content = $('\
        <div class="modal-dialog" role="document">\
            <div class="modal-content">\
                <div class="modal-body">\
                    <div class="row" style="padding-left:20px; height:42px;line-height:42px;">\
                        <div class="fa-3x text-aqua" style="display: block;float:left;">\
                            <i class="fa fa-spinner fa-pulse"></i>\
                        </div>\
                        <h4 style="display: block; float:left; padding-left: 10px;">' + title + '<small class="timer"><small></h4>\
                    </div>\
                </div>\
            </div>\
        </div>');

        if ($body.length) {
            $content.appendTo($modal);
            $modal.appendTo($body);
        }

        // 模态窗体关闭事件 
        $("#" + modalId).on("hidden.bs.modal", function () {
            $("#" + modalId).remove();
        });

        $("#" + modalId).on('shown.bs.modal', function (e) {
            // 关键代码，如没将modal设置为 block，则$modala_dialog.height() 为零  
            //$(this).css('display', 'block');
            //var modalHeight = $(window).height() / 2 - $("#" + modalId + " .modal-dialog").height() / 2;
            //$(this).find('.modal-dialog').css({
            //    'margin-top': modalHeight
            //});
        });
    };


    // 编辑模态窗体
    var editModalLoad = function (modalId, multi, selectedData, callback) {

        var $form = $('\
            <form id="edit-form">\
            <div class="form-group">\
                <label>Username</label>\
                <input type="text" class="form-control" name="username" id="username" />\
            </div>\
            <div class="form-group">\
                <label>Email address</label>\
                <input type="text" class="form-control" name="email" id="email" />\
            </div>\
            </form>');

        var $footer = $('\
                <button type="button" class="btn btn-default" data-dismiss="modal">\
                    <span class="glyphicon glyphicon-floppy-remove" aria-hidden="true"></span> 关闭\
                </button>\
                <button type="button" class="btn btn-primary" id="btnSave">\
                    <span class="glyphicon glyphicon-floppy-saved" aria-hidden="true"></span> 保存\
                </button>');

        $form.appendTo($('#' + modalId + " .modal-body"));
        $footer.appendTo($('#' + modalId + " .modal-footer"));

        // 模态窗体关闭事件 
        $("#" + modalId).on("hidden.bs.modal", function () {
            $("#" + modalId).remove();
        });


        // 表单对象验证字段
        var editValidFields = {
            username: {
                message: '用户名验证失败',
                validators: {
                    notEmpty: {
                        message: '用户名不能为空'
                    },
                    stringLength: {
                        min: 6,
                        max: 18,
                        message: '用户名长度必须在6到18位之间'
                    },
                    regexp: {
                        regexp: /^[a-zA-Z0-9_]+$/,
                        message: '用户名只能包含大写、小写、数字和下划线'
                    }
                }
            },
            email: {
                validators: {
                    notEmpty: {
                        message: '邮箱不能为空'
                    },
                    emailAddress: {
                        message: '邮箱地址格式有误'
                    }
                }
            }

            //username: {
            //    message: '用户名验证失败',
            //    validators: {
            //        notEmpty: {
            //            message: '用户名不能为空'
            //        }
            //    }
            //},
            //email: {
            //    validators: {
            //        notEmpty: {
            //            message: '邮箱地址不能为空'
            //        }
            //    }
            //}
        };

        // 验证表单 
        // 参数 ： form 表单,fields 表单验证规则,submitbutton 指定提交按钮
        var validForm = function(form, fields, submitbutton) {
            // 验证
            form.bootstrapValidator({
                live: "enabled", //验证时机，enabled是内容有变化就验证（默认），disabled和submitted是提交再验证  
                excluded: [":disabled", ":hidden", ":not(:visible)"], //排除无需验证的控件，比如被禁用的或者被隐藏的  
                submitButtons: submitbutton, //指定提交按钮，如果验证失败则变成disabled，但我没试成功，反而加了这句话非submit按钮也会提交到action指定页面  
                message: "通用的验证失败消息", //好像从来没出现过  
                feedbackIcons: {
                    //根据验证结果显示的各种图标  
                    valid: "glyphicon glyphicon-ok",
                    invalid: "glyphicon glyphicon-remove",
                    validating: "glyphicon glyphicon-refresh"
                },
                fields: fields
            }).on('success.form.bv', function(e) {
                // 阻止默认事件提交
                e.preventDefault();
            });
        };


        $("#btnSave").unbind("click").bind("click", function(e) { // 栏目数据保存

            if ($form) validForm($form, editValidFields);

            $form.bootstrapValidator('validate'); //提交验证  

            if ($form.data('bootstrapValidator').isValid()) { //获取验证结果，如果成功，执行下面代码  
                alert("yes"); //验证成功后的操作，如ajax  

                if (callback) {
                    selectedData.clear();
                    //var rows = $selectedTable.bootstrapTable('getData');
                    //$.each(rows, function () {
                    //    var data = { id: this.CatalogId, name: this.CatalogName };
                    //    selectedData.push(data);
                    //});
                    callback(selectedData);
                }

                $("#" + modalId).modal('toggle');

            }

            e.preventDefault();
            return false;


            // 提交验证 
            //var valid = $form.data('bootstrapValidator');
            //valid.validate();
            //if (!valid.isValid()) return false;

            //var txtId = $("#txtId").val();
            //var txtName = $("#txtName").val();

            //if (txtName.length == 0) {
            //    $.messager.alert('操作提示', '请填写菜单名称！');
            //    $("#txtName").focus();
            //    return;
            //}

            //var params = {
            //    id: txtId,
            //    name: $("#txtName").val(),
            //    pId: $("#txtPId").val(),
            //    mUrl: $('#txtUrl').val(),
            //    icon: $("#txtIcon").val(),
            //    idx: $('#txtIdx').val(),
            //    available: document.getElementById("chbAvailable").checked ? "1" : "0"
            //};

            var params = null;

            $.ajax({
                type: "POST",
                url: "/Handler/MenuHandler.ashx?OP=SAVE&rnd=" + (Math.random() * 10),
                data: params,
                success: function(rst) {
                    if (rst && rst.success) {
                        //if (txtId.length > 0) {
                        //    $table.bootstrapTable('updateByUniqueId', {
                        //        id: txtId,
                        //        row: {
                        //            Name: $("#txtName").val(),
                        //            Url: $('#txtUrl').val(),
                        //            Idx: $("#txtIdx").val(),
                        //            Available: document.getElementById("chbAvailable").checked ? "1" : "0",
                        //            Remark: $('#txtRemark').val()
                        //        }
                        //    });
                        //}

                        //refreshTable();

                        $.messager.show({ title: "操作提示", msg: rst.Message, timeout: 3000, showType: "fade" });

                        $('#' + id).modal('hide');
                    } else {
                        $.messager.alert("提示", rst.Message, "error");
                    }
                }
            });

            //e.preventDefault();
            //return false;
        });
    };


    //覆盖Modal.prototype的hideModal方法      
    $.fn.modal.Constructor.prototype.hideModal = function () {
        var that = this;
        this.$element.hide();
        this.backdrop(function () {
            //判断当前页面所有的模态框都已经隐藏了之后body移除.modal-open，即body出现滚动条。                
            $('.modal.fade.in').length === 0 && that.$body.removeClass('modal-open');
            that.resetAdjustments();
            that.resetScrollbar();
            that.$element.trigger('hidden.bs.modal');
        });
    };

</script>

</head>
<body>
<div class="container-fluid">
    <div class="row">

        <button type="button" class="btn btn-primary" id="btnCircleBar">
            圆形进度条模态窗体
        </button>

        <button type="button" class="btn btn-primary" id="btnProgressBar">
            Launch Progress Modal
        </button>

        <button type="button" class="btn btn-primary" id="btnEditModal">
            Launch Edit And Form Valid Modal
        </button>

    </div>
</div>
</body>
</html>